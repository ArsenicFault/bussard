-- -*- lua -*-

local prompt = "> "

define_mode("console")
ship.modes.console.parent = ship.modes.edit -- most keys work like in edit mode

bind("console", "return", function()
        local input = string.sub(ship.editor.get_line(0), string.len(prompt)+1)
        print(ship.editor.get_line(0))
        ship.editor.suppress_read_only(function()
              ship.editor.end_of_buffer()
              ship.editor.beginning_of_line()
              ship.editor.kill_line()
              ship.editor.insert({prompt})
              ship.editor.end_of_line()
        end)

        local chunk, err = loadstring("return " .. input)
        if(err and not chunk) then
           chunk, err = loadstring(input)
           if(not chunk) then
              print("! Compilation error: " .. err or "Unknown error")
              return false
           end
        end

        local result, trace = pack(xpcall(chunk, function(e)
                                             trace = debug.traceback()
                                             err = e end))
        if(result[1]) then
           local results, i = lume.serialize(result[2], true), 3
           if result[2] == ship.editor.invisible then return true end
           while i <= #result do
              results = results .. ', ' .. lume.serialize(result[i], true)
              i = i + 1
           end
           print(results)
           return true
        else
           print(err_msg)
           print(trace)
           print('! Evaluation error: ' .. err_msg)
        end

end)

-- TODO: port from old console
-- read-only prompt
-- history
-- completion
-- one-line console in flight mode
