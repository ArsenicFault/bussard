-- This -*- lua -*- code runs inside your ship's own computer.

-- controls are for keys that need to keep activating when held down; bind
-- is for commands that only call their functions once even when held
ship.controls = {
   up = ship.actions.forward,
   left = ship.actions.left,
   right = ship.actions.right,
   ["="] = function(d) if d then ship.scale = ship.scale - (ship.dt/2) end end,
   ["-"] = function(d) if d then ship.scale = ship.scale + (ship.dt/2) end end,
}

-- Flight mode
define_mode("flight")

bind("flight", "escape", ship.ui.pause)
bind("flight", "ctrl-return", lume.fn(ship.editor.change_buffer, "*console*"))

-- ctrl-tab selects closest target; repeated ctrl-tab selects next-closest
local closest_cycle = 1
bind("flight", "ctrl-tab", function()
        ship.actions.closest_target(closest_cycle)
        closest_cycle = closest_cycle + 1
end)

-- regular tab selects next target in "order"
bind("flight", "tab", function()
        closest_cycle = 1 -- clears state of ctrl-tab cycling
        ship.actions.next_target()
end)

dofile("src.hud") -- heads-up display during flight mode

-- other modes
dofile("src.edit") -- editor
dofile("src.mail") -- mail client
dofile("src.console") -- console for interacting with ship's computer
dofile("src.ssh") -- ssh mode for interacting with station/planet computers

-- multi-mode bindings

bind({"flight", "edit"}, "ctrl-q", ship.ui.quit)

-- open mail client
bind({"flight", "edit"}, "ctrl-m", function()
        ship.editor.change_buffer("*console*")
        mail()
end)

-- to open a file
bind({"flight", "edit"}, "alt-o", function()
        ship:read_line("Open: ", lume.fn(ship.editor.open, ship))
end)

-- reload config
bind({"flight", "edit"}, "ctrl-r",
     function()
        ship.dofile("src.config")
        ship.editor.initialize()
end)

-- connect to target over ssh
bind({"flight", "edit"}, "ctrl-s", function()
        ship.editor.change_buffer("*console*")
        ssh()
end)
