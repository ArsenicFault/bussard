-- This -*- lua -*- code defines your message client.

-- There are two modes; mail and view. The first is for listing/navigating your
-- mail, and the second defines a mode for reading messages.

mail = function()
   ship.editor.open(nil, "*mail*")
   ship:activate_mode("mail")
end

define_mode("mail")

local targets = {}

local header = function(lines, header)
   for _,line in ipairs(lines) do
      local match = line:match(header .. ": (.+)")
      if(match) then return match end
   end
end

local describe = function(msg)
   local lines = lume.split(msg, "\n")
   local date = utils.pad_to(header(lines, "Date"), 25)
   local from = utils.pad_to(header(lines, "From"), 25)
   local subject = header(lines, "Subject")
   return date .. " | " .. from .. " | " .. subject
end

local open_folder = function(folder)
   ship.editor.set_read_only(false)
   ship.editor.end_of_buffer()
   local point, point_line = ship.editor.point()
   ship.editor.delete(1, 0, point_line, point)

   local p = function(x) ship.editor.raw_write(x .. "\n") end
   targets = {}

   if(folder) then
      -- TODO/blocker: sort by date
      p("Folder: " .. folder .. "\n")
      for name,msg in pairs(ship.docs.mail[folder]) do
         if(name ~= "_unread") then
            table.insert(targets, {folder, name})
            if(ship.docs.mail[folder]._unread[name]) then
               p(" * " .. describe(msg))
            else
               p(" - " .. describe(msg))
            end
         end
      end
   else
      p("Folders\n")
      for name in pairs(ship.docs.mail) do
         table.insert(targets, name)
         local unread_count = lume.count(ship.docs.mail[name]._unread)
         local count = lume.count(ship.docs.mail[name]) - 1
         p(" [" .. unread_count .. "/" .. count .. "] " .. name)
      end
   end
   ship.editor.beginning_of_buffer()
   ship.editor.next_line()
   ship.editor.next_line()
   ship.editor.set_read_only(true)
end

ship.modes.mail.activate = open_folder

ship.modes.mail.parent = ship.modes.edit -- nav keys should be intact

bind("mail", "return", function()
        local line = ship.editor.get_line_number()
        local target = targets[line-2] -- two lines at the top before listing

        if(type(target) == "table") then -- two values means a message
           local folder, name = unpack(target)
           ship.editor.open(ship, "docs.mail." .. folder .. "." .. name)
           ship:activate_mode("view")
           ship.docs.mail[folder]._unread[name] = nil
        else -- single value means open a folder
           open_folder(target)
        end
end)

define_mode("view")

ship.modes.view.parent = ship.modes.edit -- nav keys should be intact
ship.modes.view.activate = lume.fn(ship.editor.set_read_only, true)

-- TODO
-- actually deliver mail to your maildir
-- unread tracking
