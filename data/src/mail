-- This -*- lua -*- code defines your message client.

-- There are two modes; mail and view. The first is for listing/navigating your
-- mail, and the second defines a mode for reading messages.

mail = function()
   ship.editor.open(nil, "*mail*")
   ship:activate_mode("mail")
end

define_mode("mail")

local targets = {}

local header = function(lines, header)
   for _,line in ipairs(lines) do
      local match = utf8.match(line, header .. ": (.+)")
      if(match) then return match end
   end
end

local describe = function(msg)
   local lines = lume.split(msg, "\n")
   local date = utils.pad_to(header(lines, "Date"), 17)
   local from = utils.pad_to(header(lines, "From"), 42)
   local subject = header(lines, "Subject")
   return date .. " | " .. from .. " | " .. subject
end

local subjects_by_date = function(msgs)
   local by_date, names = {}, {}
   for name, msg in pairs(msgs) do
      if(name ~= "_unread") then
         by_date[utils.parse_time(header(lume.split(msg, "\n"), "Date"))] = name
      end
   end
   for _, date in ipairs(lume.sort(lume.keys(by_date))) do
      table.insert(names, by_date[date])
   end
   return names
end

local open_folder = function(folder)
   ship.editor.set_read_only(false)
   ship.editor.end_of_buffer()
   local point, point_line = ship.editor.point()
   ship.editor.delete(1, 0, point_line, point)

   local p = function(x) ship.editor.raw_write(x .. "\n") end
   targets = {}

   if(folder) then
      p("Folder: " .. folder .. "\n")
      local msgs = ship.docs.mail[folder]
      for _,name in ipairs(subjects_by_date(msgs)) do
         local msg = msgs[name]
         if(name ~= "_unread") then
            table.insert(targets, {folder, name})
            if(ship.docs.mail[folder]._unread[name]) then
               p(" * " .. describe(msg))
            else
               p(" - " .. describe(msg))
            end
         end
      end
   else
      p("Folders\n")
      local folder_list = lume.sort(lume.keys(ship.docs.mail))
      lume.remove(folder_list, "inbox")
      table.insert(folder_list, 1, "inbox")
      for _,name in ipairs(folder_list) do
         table.insert(targets, name)
         local unread_count = lume.count(ship.docs.mail[name]._unread)
         local count = lume.count(ship.docs.mail[name]) - 1
         p(" [" .. unread_count .. "/" .. count .. "] " .. name)
      end
   end
   ship.editor.beginning_of_buffer()
   ship.editor.next_line()
   ship.editor.next_line()
   ship.editor.set_read_only(true)
end

ship.modes.mail.activate = open_folder
ship.modes.mail.parent = ship.modes.edit -- nav keys should be intact

local reply_key = "alt-return"

local view_modeline = function(b)
   local id = header(ship.editor.get_lines(), "Message.Id")
   if(replyable(id)) then
      return utf8.format(" %s  %s  (%s/%s)  %s   Press %s to reply.",
                         b.needs_save and "*" or "-",
                         b.path, b.point_line, #b.lines, b.mode, reply_key)
   else
      return utf8.format(" %s  %s  (%s/%s)  %s", b.needs_save and "*" or "-",
                         b.path, b.point_line, #b.lines, b.mode)
   end
end

bind("mail", "return", function()
        local line = ship.editor.get_line_number()
        local target = targets[line-2] -- two lines at the top before listing

        if(type(target) == "table") then -- two values means a message
           local folder, name = unpack(target)
           ship.docs.mail[folder]._unread[name] = nil
           open_folder(folder)
           ship.editor.open(ship, "docs.mail." .. folder .. "." .. name)
           ship:activate_mode("view")
           ship.editor.set_modeline(view_modeline)
        else -- single value means open a folder
           open_folder(target)
        end
end)

local archive_from_folder = function()
   local line = ship.editor.get_line_number()
   local target = targets[line-2] -- two lines at the top before listing
   if(type(target) == "table") then -- two values means a message
      local folder, name = unpack(target)
      ship.docs.mail.archive[name] = ship.docs.mail[folder][name]
      ship.docs.mail[folder][name] = nil
      open_folder(folder)
   end
end

-- TODO: make this visible in modeline or something?
bind("mail", "alt-a", archive_from_folder)

define_mode("view")

local archive = function()
   local path = ship.editor.current_buffer_path()
   local _, _, folder, name = unpack(lume.split(path, "."))
   ship.docs.mail.archive[name] = ship.docs.mail[folder][name]
   ship.docs.mail[folder][name] = nil
   ship.editor.close()
   ship.editor.change_buffer("*mail*")
   open_folder(folder)
end

bind("view", "alt-a", archive)

ship.modes.view.parent = ship.modes.edit -- nav keys should be intact
ship.modes.view.activate = lume.fn(ship.editor.set_read_only, true)

-- accept mission
bind("view", reply_key, function()
        local id = header(ship.editor.get_lines(), "Message.Id")
        local success, status = reply(id)
        ship.editor.close()
        ship.editor.open(ship, "*console*")
        if(success) then
           print("Replied.", status)
        else
           print(status)
        end
end)
