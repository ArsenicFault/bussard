-- This -*- lua -*- defines a mode based on console mode, but for communicating
-- with another OS over an SSH connection.

ssh = function(username, password)
   editor.change_buffer("*console*")
   local send = ssh_connect(username or "guest", password or "")
   if(send) then
      editor.activate_mode("ssh")
      editor.end_of_buffer()
      editor.no_mark()
      editor.set_prop("ssh_send", send)
   end
end

ssh_prompt = function(username1, password1)
   if(username1) then
      ssh(username1, password1 or "")
      return editor.invisible
   end
   if(not ship.status.target or not ship.status.target.os) then
      print("No target host; cannot log in.")
      return editor.invisible
   elseif(utils.distance(ship.status, ship.status.target) >
          ship.status.comm_range) then
      print("Target out of range.")
      return editor.invisible
   end
   local callback = function(username, cancel)
      if(cancel) then return end
      if(username == "") then username = "guest" end
      local callback2 = function(password, cancel2)
         if(cancel2) then return end
         ssh(username, password)
      end
      editor.read_line("Password: ", callback2)
   end
   editor.read_line("SSH username (defaults to guest): ", callback)
   return editor.invisible
end

portal = function()
   if(ship.status.target and ship.status.target.portal) then
      ssh_connect("guest", "")
   else
      print("Cannot activate portal.")
   end
   return editor.invisible
end

local complete = function()
   local input = lume.trim(editor.get_input())
   local send = editor.get_prop("ssh_send")
   if(input and send) then send({op="complete", ssrpc=true, input=input}) end
end

-- inherit bindings from console
define_mode("ssh", "console", {complete=complete})

-- send input to whatever remote OS you're connected to.
bind("ssh", "return", function()
        local input = lume.trim(editor.get_input())

        editor.history_push(input)
        local send = editor.get_prop("ssh_send")
        if(input and send) then
           send(input)
           editor.newline(2)
           editor.print_prompt()
           editor.end_of_buffer()
           editor.no_mark()
        elseif(input) then
           print("Not connected.")
        end
end)

bind("ssh", "ctrl-d", function()
        local _, line = editor.point()
        if(line == editor.get_max_line() and
           editor.get_input() == "") then
           local send = editor.get_prop("ssh_send")
           send("logout")
        else
           editor.delete_forwards()
        end
end)

bind("ssh", "tab", complete)
