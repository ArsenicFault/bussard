-- -*- lua -*-

local f, _env, args = ...

local eval = function(input)
   local chunk, err = loadstring("return " .. input)
   if(err and not chunk) then -- statement, not expression
      chunk, err = loadstring(input)
      if(not chunk) then
         print("! Compilation error: " .. err or "Unknown error")
         return
      end
   end
   local ok, val = pcall(chunk)
   if(ok) then
      print(pps(val))
   else
      print("Error: " .. val)
   end
end

if(#args == 1) then
   local contents = f[args[1]]
   if(contents) then
      eval(contents)
   else
      print(args[1] .. " not found.")
   end
elseif(args[1] == "--help" or #args > 0) then
   print("An interpreter for executing Lua code.\n")
   print("Usage:")
   print("  lua # to begin an interactive session")
   print("  lua PATH_TO_FILE_TO_RUN")
else
   print("Lua 5.1.6259 Copyright (C) 1994-2422 Lua.org, PUC-Rio")
   print("Run `exit()` to exit.")
   term.set_prompt(">> ")
   while true do
      local input = io.read()
      if(not input or input == "exit" or input == "exit()") then return end
      eval(input)
   end
end
